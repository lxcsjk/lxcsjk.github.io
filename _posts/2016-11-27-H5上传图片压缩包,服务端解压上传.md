---
layout: post
title:  "h5ä¸Šä¼ å›¾ç‰‡å‹ç¼©åŒ…æœåŠ¡ç«¯è§£å‹å¹¶ä¸Šä¼ å›¾ç‰‡"
date:   2016-11-27 19:40:03 +0800
categories: jekyll update
tags: IDEA ä¸Šä¼  è§£å‹ 
---


CMSåå°æœ‰ä¸Šä¼ å¤šä¸ªå›¾ç‰‡çš„éœ€æ±‚ï¼Œå¤šä¸ªå›¾ç‰‡ä¸Šä¼ ä¹Ÿä¸€æ ·éº»çƒ¦ã€‚å°±æƒ³åšä¸ªä¸Šä¼ å‹ç¼©åŒ…æœåŠ¡ç«¯è§£å‹ä¸Šä¼ çš„ä¸œè¥¿ã€‚

### é¡µé¢

ä½¿ç”¨h5çš„ä¸Šä¼ api

```
 	  /*
             *
             * name: ä¸Šä¼ å­—æ®µæ ‡ç¤º
             postUrl: æ–‡ä»¶æ•°æ®å¤„ç†URL
             onClientAbort: è¯»å–æ“ä½œç»ˆæ­¢æ—¶è°ƒç”¨
             onClientError: å‡ºé”™æ—¶è°ƒç”¨
             onClientLoad: è¯»å–æ“ä½œæˆåŠŸæ—¶è°ƒç”¨
             onClientLoadEnd: æ— è®ºæ˜¯å¦æˆåŠŸï¼Œè¯»å–å®Œæˆæ—¶è°ƒç”¨ã€‚é€šå¸¸åœ¨onloadå’Œonerroråè°ƒç”¨
             onClientLoadStart: è¯»å–å°†è¦å¼€å§‹æ—¶è°ƒç”¨
             onClientProgress: æ•°æ®åœ¨è¯»å–è¿‡ç¨‹ä¸­å‘¨æœŸæ€§è°ƒç”¨
             onServerAbort: postæ“ä½œç»“æŸæ—¶è°ƒç”¨
             onServerError: é”™è¯¯å‘ç”Ÿæ—¶è°ƒç”¨
             onServerLoad: postæ“ä½œæˆåŠŸæ—¶è°ƒç”¨
             onServerLoadStart: postæ•°æ®å°†è¦å¼€å§‹æ—¶è°ƒç”¨
             onServerProgress: æ•°æ®æ­£åœ¨è¢«postçš„è¿‡ç¨‹ä¸­å‘¨æœŸæ€§è°ƒç”¨
             onServerReadyStateChange: ä¸€ä¸ªjavascriptåŠŸèƒ½å¯¹è±¡æ— è®ºä»»ä½•æ—¶å€™readyStateå±æ€§å˜åŒ–æ—¶è°ƒç”¨ã€‚callbackç”±ç”¨æˆ·ç•Œé¢ç°æˆè°ƒç”¨ã€‚
             *
             *
             * */

            $("#uploadZip").html5Uploader({
                url: "rest/material/uploadZip",
                onSuccess: function (e, file, response) {
                    var res = JSON.parse(response);
                    if (res == "200") {
                        $.sticky("å·²ç»æˆåŠŸä¸Šä¼ å¹¶ä¸”å­˜å…¥åŸå§‹ç´ æåº“ï¼");
                        swal("SUCCESS!", "å·²ç»æˆåŠŸä¸Šä¼ å¹¶ä¸”å­˜å…¥åŸå§‹ç´ æåº“ï¼", "success");
                    } else {
                        $.sticky("å‹ç¼©æ ¼å¼é”™è¯¯æˆ–å‹ç¼©è¿‡ç¨‹å‡ºç°é”™è¯¯");
                        swal("OMG!", "å‹ç¼©åŒ…æœ‰é”™è¯¯è¯·é‡æ–°å‹ç¼©å¹¶é‡æ–°ä¸Šä¼  = = ï¼ï¼ï¼", "error");
                    }
                },
                onClientLoad: function () {
                    $.sticky("æ–‡ä»¶è¯»å–æˆåŠŸ! ! !");
                },
                onClientLoadEnd: function () {
                    $.sticky("æ–‡ä»¶ä¸Šä¼ å®Œæˆ! ! !");
                },
                onClientLoadStart: function () {
                    $.sticky("æ–‡ä»¶å°†è¦å¼€å§‹è¯»å–! ! !");
                },
                onClientProgress: function () {

                },
                onServerError: function () {
                    console.log(11111111 + "========")
                },
                onServerProgress: function () {
                    $.sticky("æ–‡ä»¶æ­£åœ¨ä¸Šä¼ ! ! !");
                }
            });

```
ç”¨äº†ä¸€äº›ç¾åŒ–è¿‡çš„å¼¹çª—æ§ä»¶

[SweetAlert](http://www.dglives.com/demo/sweetalert-master/example/)

å¼•å…¥jså°±è¡Œäº†ã€‚

åå°æ¨¡æ¿ä¹‹å‰å¸¸ç”¨[ACE](https://github.com/bopoda/ace)çš„ã€‚
æ‰£ä¸‹æ¥æ”¹å§æ”¹å§ã€‚


### æœåŠ¡ç«¯ 

æœåŠ¡ç«¯ç”¨çš„Javaå†™çš„ã€‚

```

    @Transactional
    @RequestMapping(value = "uploadZip", method = RequestMethod.POST)
    public Map<String, Object> uploadZip(HttpServletRequest request) throws Exception {

        Map<String, Object> result = new HashMap<>();
        User user = GrantedFilter.threadLocal.get();
        final Integer userId = user.getId();

        Uploader uploader = new Uploader(request);
        // è§£å‹
        final File[] fileList = uploader.uploadMaterialZip();
        // æœ‰æ—¶å€™å‹ç¼©ä¼šå‡ºé—®é¢˜  Mac å’Œ Windows 
        if (fileList.length < 1 || fileList.length>1?fileList[1].isDirectory():fileList[0].isDirectory()) {
            File f = null;
            try {
                f = new File(fileList[0].getParent());
                deleteFile(f);
            } catch (Exception e) {

            }
            result.put("code", "400");
            return result;
        } else {
            threadPoolTaskExecutor.execute(new Runnable() {
                @Override
                public void run() {
                    String temp = fileList[0].getParent();
                    for (File file : fileList) {
                        if (file.getName().endsWith(".gif")||file.getName().endsWith(".GIF")) {
                            UFileRequest uFileRequest = new UFileRequest();
                            String gifKey = RandomStringUtils.randomAlphanumeric(32) + ".gif";
                            uFileRequest.setBucketName(SysConfigDao.getValue(SysConfig.otherConfig, "ufile_bucket"));
                            uFileRequest.setFilePath(file.getPath());
                            uFileRequest.setKey(gifKey);
                            uFileAPI.putFile(uFileRequest);
                            String url = uFileAPI.getDownloadUrl(uFileRequest, 0, false);
                            MaterialRaw materialRaw = new MaterialRaw();
                            materialRaw.setTag("3");
                            materialRaw.setGifurl(url);
                            materialRaw.setCreateAt(new Date());
                            materialRaw.setStatus("t");
                            materialRaw.setChannl("r");
                            try {
                                materialRaw.setMd5(MD5Util.getMd5ByFile(file));
                            } catch (FileNotFoundException e) {
                                e.printStackTrace();
                            }
                            materialRaw.setSize((int) file.length());
                            materialRaw.setCreateBy(userId);
                            try {
                                materialRaw.setTitle(file.getName().substring(0, file.getName().lastIndexOf(".gif")));
                            } catch (Exception e) {
                                materialRaw.setTitle(file.getName().substring(0, file.getName().lastIndexOf(".GIF")));
                            }
                            materialRawDao.save(materialRaw);
                        }
                        file.delete();
                    }
                    File f = new File(temp);
                    deleteFile(f);
                }
            });
        }
        result.put("code", "200");
        return result;
    }


```

è§£å‹çš„Utilç±»


```
    public File[] uploadMaterialZip() throws Exception {
        originalName = request.getHeader("X-File-Name");
        type = FileUtil.getFileExt(originalName);
        if (!".zip".equals(type.toLowerCase())) {
            throw new BadRequestException("æ ¼å¼é”™è¯¯ï¼");
        }
        if (request.getContentLength() / 1024000 > 100) {
            throw new BadRequestException("æ–‡ä»¶å¤ªå¤§ï¼");
        }
        fileName = Util.RunTimeSequence() + type;
        path = DateUtil.zipDateFormat(new Date()) + File.separator + fileName;
        File file = new File(savePath + File.separator + path);
        file.getParentFile().mkdirs();
        try (InputStream is = request.getInputStream();
             FileOutputStream fos = new FileOutputStream(file)) {
            IOUtils.copy(is, fos);
            size = file.length();
        }
        String str = savePath + File.separator + System.currentTimeMillis();
        File dir = new File(str);
        if (!dir.exists() || !dir.isDirectory()) {
            dir.mkdirs();
        }
        String temp = savePath + File.separator + DateUtil.zipDateFormat(new Date()) + File.separator;
        // åŠ å‹çš„å·¥å…·ç±»
        DeCompressUtil.deCompress(savePath + File.separator + path, str, temp);
        File gifFile = new File(str);
        File[] fileList = gifFile.listFiles();
        if (fileList.length<1){
            gifFile.delete();
        }
        return fileList;
    }

```

è§£å‹

```
package com.an.core.utils.zip;

import com.an.core.exception.BadRequestException;
import de.innosystec.unrar.Archive;
import de.innosystec.unrar.rarfile.FileHeader;
import org.apache.tools.ant.Project;
import org.apache.tools.ant.taskdefs.Expand;

import java.io.File;
import java.io.FileOutputStream;

public class DeCompressUtil {
    /**
     * è§£å‹zipæ ¼å¼å‹ç¼©åŒ…
     * å¯¹åº”çš„æ˜¯ant.jar
     */
    private static void unzip(String sourceZip, String destDir, String temp) throws Exception {
        try {
            Project p = new Project();
            Expand e = new Expand();
            e.setProject(p);
            e.setSrc(new File(sourceZip));
            e.setOverwrite(false);
            e.setDest(new File(destDir));
           /*
           antä¸‹çš„zipå·¥å…·é»˜è®¤å‹ç¼©ç¼–ç ä¸ºUTF-8ç¼–ç ï¼Œ
           è€ŒwinRARè½¯ä»¶å‹ç¼©æ˜¯ç”¨çš„windowsé»˜è®¤çš„GBKæˆ–è€…GB2312ç¼–ç 
           æ‰€ä»¥è§£å‹ç¼©æ—¶è¦åˆ¶å®šç¼–ç æ ¼å¼
           */

            try {
                e.setEncoding("GBK");
                e.execute();
            } catch (Exception e1) {
                e.setEncoding("UTF-8");
                e.execute();
            }
            File zipFile = new File(sourceZip);
            File zipPath = new File(temp);
            zipFile.delete();
            zipPath.delete();

        } catch (Exception e) {
            throw new BadRequestException(e);
        }
    }

    /**
     * è§£å‹raræ ¼å¼å‹ç¼©åŒ…ã€‚
     * å¯¹åº”çš„æ˜¯java-unrar-0.3.jarï¼Œä½†æ˜¯java-unrar-0.3.jaråˆä¼šç”¨åˆ°commons-logging-1.1.1.jar
     */
    private static void unrar(String sourceRar, String destDir, String temp) throws Exception {
        Archive a = null;
        FileOutputStream fos = null;
        try {
            a = new Archive(new File(sourceRar));
            FileHeader fh = a.nextFileHeader();
            while (fh != null) {
                if (!fh.isDirectory()) {
                    //1 æ ¹æ®ä¸åŒçš„æ“ä½œç³»ç»Ÿæ‹¿åˆ°ç›¸åº”çš„ destDirName å’Œ destFileName
                    String compressFileName = fh.getFileNameString().trim();
                    String destFileName = "";
                    String destDirName = "";
                    //éwindowsç³»ç»Ÿ
                    if (File.separator.equals("/")) {
                        destFileName = destDir + compressFileName.replaceAll("\\\\", "/");
                        destDirName = destFileName.substring(0, destFileName.lastIndexOf("/"));
                        //windowsç³»ç»Ÿ
                    } else {
                        destFileName = destDir + compressFileName.replaceAll("/", "\\\\");
                        destDirName = destFileName.substring(0, destFileName.lastIndexOf("\\"));
                    }
                    //2åˆ›å»ºæ–‡ä»¶å¤¹
                    File dir = new File(destDirName);
                    if (!dir.exists() || !dir.isDirectory()) {
                        dir.mkdirs();
                    }
                    //3è§£å‹ç¼©æ–‡ä»¶
                    fos = new FileOutputStream(new File(destFileName));
                    a.extractFile(fh, fos);
                    fos.close();
                    fos = null;
                }
                fh = a.nextFileHeader();
            }
            a.close();
            a = null;
        } catch (Exception e) {
            throw e;
        } finally {
            if (fos != null) {
                try {
                    fos.close();
                    fos = null;
                } catch (Exception e) {
                    e.printStackTrace();
                }
            }
            if (a != null) {
                try {
                    a.close();
                    a = null;
                } catch (Exception e) {
                    e.printStackTrace();
                }
            }
        }
    }

    /**
     * è§£å‹ç¼©
     */
    public static void deCompress(String sourceFile, String destDir, String temp) throws Exception {
        //ä¿è¯æ–‡ä»¶å¤¹è·¯å¾„æœ€åæ˜¯"/"æˆ–è€…"\"
        char lastChar = destDir.charAt(destDir.length() - 1);
        if (lastChar != '/' && lastChar != '\\') {
            destDir += File.separator;
        }
        //æ ¹æ®ç±»å‹ï¼Œè¿›è¡Œç›¸åº”çš„è§£å‹ç¼©
        String type = sourceFile.substring(sourceFile.lastIndexOf(".") + 1);
        if (!".zip".equals(type.toLowerCase())) {
            DeCompressUtil.unzip(sourceFile, destDir, temp);
        } else if (type.equals("rar")) {
            DeCompressUtil.unrar(sourceFile, destDir, temp);
        } else {

        }
    }
} 

```

åˆ é™¤æ–‡ä»¶å¤¹ä¸‹é¢çš„æ‰€æœ‰å†…å®¹

```
	/**
	 * åˆ é™¤æ–‡ä»¶å¤¹æ‰€æœ‰çš„æ–‡ä»¶å’Œæ–‡ä»¶å¤¹
	 *
	 * @param file
     */
	public static void deleteFile(File file){
		if(file.isFile()){
			file.delete();
			return;
		}
		if(file.isDirectory()){
			File[] childFile = file.listFiles();
			if(childFile == null || childFile.length == 0){
				file.delete();
				return;
			}
			for(File f : childFile){
				RecursionDeleteFile(f);
			}
			file.delete();
		}
	}

```

ä¹‹å‰æœ‰æ‰¾è¿‡ä¸€ä¸ª[Demo](http://download.csdn.net/detail/clyao_123456/7624815)

[ä¸‹è½½é“¾æ¥](http://oh6uhie7j.bkt.clouddn.com/MyUpload.zip)

å¸Œæœ›å¯¹ä½ æœ‰å¸®åŠ© ğŸ˜‚ğŸ˜‚ğŸ˜‚ã€‚


